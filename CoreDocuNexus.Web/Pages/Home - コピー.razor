@page "/old"
@using Microsoft.AspNetCore.Components.Forms
@using System.Text.Json
@using System.Text
@using jp.in4a.CoreDocuNexus.Contracts.Http.AddPasswordToPdf
@using MudBlazor
@inject IJSRuntime JSRuntime
@inject HttpClient Http
@inject jp.in4a.CoreDocuNexus.Web.AppSettings.RootSettings Settings

@inject ISnackbar Snackbar

<PageTitle>パスガ PDF (PassGa PDF)</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">

    @* サービス名とアイコン *@
    <MudStack Spacing="1" AlignItems="AlignItems.Center">
        <MudText Typo="Typo.h3">
            <MudIcon Icon="@Icons.Material.Filled.PictureAsPdf" Color="Color.Primary"  />
            パスガ PDF (PassGa PDF)
        </MudText>

        @* サービス説明 *@
        <MudText Align="Align.Center" Class="mt-4" Style="max-width: 600px;">
            そのPDF、パスガ済み？パスッと決めて、ガシッと守る。<br />
            「パスッと設定、ガシッとガード」をコンセプトに、PDFのパスワード管理にまつわるあらゆる手間を解消し、あなたの時間を守ります。
        </MudText>
    </MudStack> 

    <MudStack Style="width: 100%">
        <MudFileUpload T="IReadOnlyList<IBrowserFile>"
                   @ref="@_fileUpload"
                   OnFilesChanged="OnInputFileChanged"
                   MaxFileSize="@MaxSizeByte"
                   Accept=".pdf"
                   Hidden="@false"
                   InputClass="absolute mud-width-full mud-height-full overflow-hidden z-10"
                   InputStyle="opacity:0"
                   tabindex="-1"
                   @ondragenter="@SetDragClass"     
                   @ondrop=     "@ClearDragClass"        
                   @ondragleave="@ClearDragClass"   
                   @ondragend=  "@ClearDragClass">
                   @* 
                    ondragenter:Itemがdrag zoneに入ったとき MudPaperの協調表示 Begin
                    ondrop     :ItemをDrop zoneの上で放すと MudPaperの協調表示 End
                    ondragleave:Itemがdrag zoneから出たとき MudPaperの協調表示 End
                    ondragend  :drag itemを放したとき       MudPaperの協調表示 End
                    *@
            <ActivatorContent>
                <MudPaper Height="300px"
                    Outlined="true"
                    Class="@_dragClass">
                    <MudText Typo="Typo.h6">
                        PDFファイルをこちらにドラッグ＆ドロップして下さい
                    </MudText>
                        @foreach (var file in _fileNames)
                        {
                            <MudChip T="string"
                                Color="Color.Dark"
                                Text="@file"
                                tabindex="-1" />
                        }
                    </MudPaper>
            </ActivatorContent>
        </MudFileUpload>
        <MudToolBar Gutters="@false">
            <MudButton StartIcon="@Icons.Material.Filled.CloudUpload"
                Color="Color.Primary"
                OnClick="@OpenFilePickerAsync"
                Variant="Variant.Filled">
                PDFファイルを選択
            </MudButton>
            <MudButton Color="Color.Primary"
                Disabled="@(!_fileNames.Any())"
                OnClick="@Upload"
                Variant="Variant.Filled">
                PDF変換
            </MudButton>
            <MudButton Color="Color.Error"
                Disabled="@(!_fileNames.Any())"
                OnClick="@ClearAsync"
                Variant="Variant.Filled">
                クリア
            </MudButton>
        </MudToolBar>
        @if (showPasswordForm2)
            {
                <!-- 閲覧パスワード入力 -->
                                <MudItem xs="6" md="6">
                                    <MudTextField @bind-Value="userPassword2"
                                                  Label="閲覧パスワード"
                                                  Variant="Variant.Outlined"
                                                  InputType="InputType.Password"
                                                  HelperText="PDFを開く際に必要なパスワード" />
                                </MudItem>
                                
                                <!-- 編集パスワード入力 -->
                                <MudItem xs="6" md="6">
                                    <MudTextField @bind-Value="ownerPassword2"
                                                  Label="編集パスワード"
                                                  Variant="Variant.Outlined"
                                                  InputType="InputType.Password"
                                                  HelperText="PDF編集時に必要なパスワード" />
                                </MudItem>
            }
    </MudStack>

    <!-- ファイル選択時の制限事項表示 -->
    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
        ※ PDFファイルのみ、@(Settings.MaxUploadFileSizeMB.ToString("0.#"))MB以下のファイルを選択してください
    </MudText>
    @code {

        private MudFileUpload<IReadOnlyList<IBrowserFile>>? _fileUpload;
        private List<IBrowserFile> _fileList = new ();
        private readonly List<string> _fileNames = new();
        private const string DefaultDragClass = "relative rounded-lg border-2 border-dashed pa-4 mt-4 mud-width-full mud-height-full";
        private string _dragClass = DefaultDragClass;

        private bool showPasswordForm2 = false;

            // パスワード関連のプロパティ
        private string userPassword2 = string.Empty;      // 閲覧パスワード
        private string ownerPassword2 = string.Empty;     // 編集パスワード

        // クリア処理
        private async Task ClearAsync()
        {
        await (_fileUpload?.ClearAsync() ?? Task.CompletedTask);
        _fileList.Clear();
        _fileNames.Clear();
        showPasswordForm2 = false;
        // MudPaperの協調表示 End
        ClearDragClass();
        }

        // ファイル選択ダイアログを開く非同期メソッド
        private Task OpenFilePickerAsync()
        => _fileUpload?.OpenFilePickerAsync() ?? Task.CompletedTask;

        // ファイル選択時の処理
        private void OnInputFileChanged(InputFileChangeEventArgs e)
        {
        try
        {
            showPasswordForm2 = false;
            // MudPaperの協調表示 End
            ClearDragClass();
                // 選択されたファイルを取得
                var files = e.GetMultipleFiles();
                foreach (var file in files)
                {
                    _fileList.Add(file);
                    _fileNames.Add(file.Name);
                    break;
                }
            }
            finally
            {
                if (_fileList.Count > 0)
                {
                    showPasswordForm2 = true;
                }
            }
        }

        // ファイルアップロードの処理
        private void Upload()
        {
            string fileNames = "";
            foreach (var file in _fileList)
            {
                fileNames += $"{file.Name} , ";
            }
            // Upload the files here
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopCenter;
            Snackbar.Add(fileNames );
        }

        // MudPaperの協調表示 Begin
        private void SetDragClass()
            => _dragClass = $"{DefaultDragClass} mud-border-primary";

        // MudPaperの協調表示 End
        private void ClearDragClass()
            => _dragClass = DefaultDragClass;
    }
    
    <!-- メインコンテンツカード -->
    <MudCard>
        <MudCardContent>
            <!-- ファイルアップロードセクション -->
            <MudGrid>
                <MudItem xs="12">
                    <MudText Typo="Typo.h6" Class="mb-3">1. PDFファイルを選択してください</MudText>
                    <MudFileUpload T="IBrowserFile" 
                        MaximumFileCount="1" 
                        FilesChanged="OnFileSelected"
                        MaxFileSize="@MaxSizeByte"
                        Accept=".pdf"
                        Class="mb-3">
                    <ActivatorContent>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.CloudUpload">
                            PDFファイルを選択
                        </MudButton>
                    </ActivatorContent>
                </MudFileUpload>

                @if (selectedFile != null)
                {
                    <MudText Class="mt-2">
                        <MudIcon Icon="@Icons.Material.Filled.InsertDriveFile" Size="Size.Small" />
                        <MudChip T="string" Color="Color.Info" Text="@selectedFile.Name" />
                        <MudText Typo="Typo.body2" Class="ml-2">
                            サイズ: @FormatFileSize(selectedFile.Size)
                        </MudText>
                    </MudText>
                }
                    
                    <!-- ファイル選択時の制限事項表示 -->
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
                        ※ PDFファイルのみ、@(Settings.MaxUploadFileSizeMB.ToString("0.#"))MB以下のファイルを選択してください
                    </MudText>
                </MudItem>
            </MudGrid>

            <!-- 処理中表示 -->
            @if (isProcessing)
            {
                <MudGrid Class="mt-4">
                    <MudItem xs="12" Class="text-center">
                        <MudProgressCircular Indeterminate="true" />
                        <MudText Typo="Typo.body1" Class="mt-2">
                            @processingMessage
                        </MudText>
                    </MudItem>
                </MudGrid>
            }

  

            <!-- パスワード設定フォーム -->
            @if (showPasswordForm)
            {
                <MudDivider Class="my-4" />
                
                <MudGrid>
                    <MudItem xs="12">
                        <MudText Typo="Typo.h6" Class="mb-3">2. パスワードを設定してください</MudText>
                        
                        <!-- パスワード設定フォーム -->
                        <MudForm @ref="passwordForm" @bind-IsValid="@isFormValid">
                            <MudGrid>
                                <!-- 閲覧パスワード入力 -->
                                <MudItem xs="12" md="6">
                                    <MudTextField @bind-Value="userPassword"
                                                  Label="閲覧パスワード"
                                                  Variant="Variant.Outlined"
                                                  InputType="InputType.Password"
                                                  HelperText="PDFを開く際に必要なパスワード"
                                                  Class="mb-3" />
                                </MudItem>
                                
                                <!-- 編集パスワード入力 -->
                                <MudItem xs="12" md="6">
                                    <MudTextField @bind-Value="ownerPassword"
                                                  Label="編集パスワード"
                                                  Variant="Variant.Outlined"
                                                  InputType="InputType.Password"
                                                  HelperText="PDF編集時に必要なパスワード"
                                                  Class="mb-3" />
                                </MudItem>
                                
                                <!-- パスワード設定に関する注意事項 -->
                                <MudItem xs="12">
                                    <MudAlert Severity="Severity.Info" Class="mb-3">
                                        <MudText Typo="Typo.body2">
                                            ・閲覧パスワード、編集パスワードのどちらか一方のみでも設定可能です<br/>
                                            ・両方とも空欄の場合は処理できません
                                        </MudText>
                                    </MudAlert>
                                </MudItem>
                                
                                <!-- パスワード設定実行ボタン -->
                                <MudItem xs="12" Class="text-center">
                                    <MudButton Variant="Variant.Filled"
                                               Color="Color.Success"
                                               Size="Size.Large"
                                               StartIcon="@Icons.Material.Filled.Lock"
                                               OnClick="SetPasswordAndDownload"
                                               Disabled="@(!CanSetPassword() || isProcessing)">
                                        パスワードを設定してダウンロード
                                    </MudButton>
                                </MudItem>
                            </MudGrid>
                        </MudForm>
                    </MudItem>
                </MudGrid>
            }

            <!-- エラーメッセージ表示 -->
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mt-4">
                    @errorMessage
                </MudAlert>
            }

            <!-- 成功メッセージ表示 -->
            @if (!string.IsNullOrEmpty(successMessage))
            {
                <MudAlert Severity="Severity.Success" Class="mt-4">
                    @successMessage
                </MudAlert>
            }
        </MudCardContent>
    </MudCard>
    
    <!-- 使用方法説明 -->
    <MudCard Class="mt-4">
        <MudCardContent>
            <MudText Typo="Typo.h6" Class="mb-3">使用方法</MudText>

            <MudList T="string">
                <MudListItem Icon="@Icons.Material.Filled.FileUpload">
                    PDFファイル（@(Settings.MaxUploadFileSizeMB.ToString("0.#"))MB以下）を選択してください
                </MudListItem>
                <MudListItem Icon="@Icons.Material.Filled.Security">
                    既にパスワードが設定されているPDFは処理できません
                </MudListItem>
                <MudListItem Icon="@Icons.Material.Filled.Lock">
                    閲覧用・編集用パスワードを個別に設定できます
                </MudListItem>
                <MudListItem Icon="@Icons.Material.Filled.Download">
                    設定完了後、パスワード付きPDFがダウンロードされます
                </MudListItem>
            </MudList>
        </MudCardContent>
    </MudCard>
</MudContainer>


 <MudLink Href="/home-g">
    Gemini
</MudLink>
<MudLink Href="/home-c">
    Claude
</MudLink>

@* <MudLink Href="/test-api">
    Test API
</MudLink> *@

@code {
    private long MaxSizeByte = 1;

    // ファイル関連のプロパティ
    private IBrowserFile? selectedFile;
    private string selectedFileName = "";

    // パスワード関連のプロパティ
    private string userPassword = string.Empty;      // 閲覧パスワード
    private string ownerPassword = string.Empty;     // 編集パスワード

    // UI状態管理のプロパティ
    private bool isProcessing = false;               // 処理中フラグ
    private bool showPasswordForm = false;           // パスワードフォーム表示フラグ
    private bool isFormValid = false;                // フォームバリデーション結果
    private string processingMessage = string.Empty; // 処理中メッセージ
    private string errorMessage = string.Empty;      // エラーメッセージ
    private string successMessage = string.Empty;    // 成功メッセージ

    // フォーム参照
    private MudForm? passwordForm;

    protected override void OnInitialized()
    {
        // settingsから最大ファイルサイズを取得
        MaxSizeByte = Convert.ToInt64(Settings.MaxUploadFileSize);
    }

    /// <summary>
    /// ファイル選択時の処理
    /// </summary>
    /// <param name="files">選択されたファイル</param>
    private async Task OnFileSelected(IBrowserFile file)
    {
        try
        {
            // 前回の状態をクリア
            ClearMessages();
            showPasswordForm = false;

            // ファイルが選択されていない場合は処理終了
            //var file = files.
            if (file == null)
            {
                selectedFile = null;
                return;
            }

            // ファイルサイズチェック（1MB = 1,048,576 bytes）
            if (file.Size > MaxSizeByte)
            {
                errorMessage = "ファイルサイズが10MBを超えています。10MB以下のファイルを選択してください。";
                return;
            }

            // PDFファイル形式チェック
            if (!file.ContentType.Equals("application/pdf", StringComparison.OrdinalIgnoreCase) &&
                !file.Name.EndsWith(".pdf", StringComparison.OrdinalIgnoreCase))
            {
                errorMessage = "PDFファイルを選択してください。";
                return;
            }

            selectedFile = file;

            showPasswordForm = true; // パスワードフォームを表示
        }
        catch (Exception ex)
        {
            errorMessage = $"ファイル選択時にエラーが発生しました: {ex.Message}";
        }
    }


    /// <summary>
    /// パスワード設定とダウンロード処理
    /// </summary>
    private async Task SetPasswordAndDownload()
    {
        if (selectedFile == null || !CanSetPassword()) return;

        try
        {
            // 処理中状態に設定
            isProcessing = true;
            processingMessage = "パスワードを設定しています...";
            ClearMessages();
            StateHasChanged();

            // ファイルをバイト配列として読み込み
            using var stream = selectedFile.OpenReadStream(maxAllowedSize: MaxSizeByte);
            var buffer = new byte[selectedFile.Size];
            await stream.ReadAsync(buffer);

            // リクエスト作成
            var request = new AddPasswordToPdfRequest
            {
                PdfFile = buffer,
                UserPassword = userPassword,
                OwnerPassword = ownerPassword
            };
            var json = JsonSerializer.Serialize(request);
            var content = new StringContent(json, Encoding.UTF8, "application/json");

            // API呼び出し
            var response = await Http.PostAsync("api/AddPasswordToPdf", content);
            var responseJson = await response.Content.ReadFromJsonAsync<AddPasswordToPdfResponse>();

            if (response.IsSuccessStatusCode)
            {
                if( responseJson == null)
                {
                    errorMessage = "APIからのレスポンスが無効です。";
                    return;
                }

                if(!responseJson.Success)
                {
                    errorMessage = $"APIエラー: {responseJson.Message}";
                    return;
                }

                // ブラウザでファイルダウンロードを実行
                await DownloadFile(responseJson.PdfFile, DateTime.Now.ToString("yyyyMMdd_HHmmss_") + selectedFile.Name);

            }
            else
            {
                // 400エラーの場合、レスポンスボディにエラー情報が含まれる
                if (response.StatusCode == System.Net.HttpStatusCode.BadRequest)
                {
                    errorMessage = "400エラー: APIエラー: 無効なリクエストです。";
                    return;
                }
                // 500エラーの場合、レスポンスボディは空
                else if (response.StatusCode == System.Net.HttpStatusCode.InternalServerError)
                {

                    errorMessage = "500エラー: サーバー内部エラー";
                    return;
                }
                else
                {
                    errorMessage =  $"{(int)response.StatusCode}エラー: {response.ReasonPhrase}";
                    return;
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"パスワード設定処理中にエラーが発生しました: {ex.Message}";
        }
        finally
        {
            // 処理中状態を解除
            isProcessing = false;
            processingMessage = string.Empty;
            StateHasChanged();
        }
    }

    /// <summary>
    /// ファイルダウンロード処理
    /// </summary>
    /// <param name="fileBytes">ファイルのバイト配列</param>
    /// <param name="fileName">ダウンロードファイル名</param>
    private async Task DownloadFile(byte[] fileBytes, string fileName)
    {
        // JavaScriptを使用してファイルダウンロードを実行
        await JSRuntime.InvokeVoidAsync("downloadFile", Convert.ToBase64String(fileBytes), fileName);
    }

    /// <summary>
    /// パスワード設定可能かチェック
    /// </summary>
    /// <returns>設定可能な場合true</returns>
    private bool CanSetPassword()
    {
        // 閲覧パスワードまたは編集パスワードのいずれかが入力されている場合に設定可能
        return !string.IsNullOrWhiteSpace(userPassword) || !string.IsNullOrWhiteSpace(ownerPassword);
    }

    /// <summary>
    /// ファイルサイズを読みやすい形式でフォーマット
    /// </summary>
    /// <param name="bytes">バイト数</param>
    /// <returns>フォーマットされた文字列</returns>
    private string FormatFileSize(long bytes)
    {
        if (bytes < 1024)
            return $"{bytes} B";
        else if (bytes < 1024 * 1024)
            return $"{bytes / 1024.0:F1} KB";
        else
            return $"{bytes / (1024.0 * 1024.0):F1} MB";
    }

    /// <summary>
    /// メッセージをクリア
    /// </summary>
    private void ClearMessages()
    {
        errorMessage = string.Empty;
        successMessage = string.Empty;
    }

    /// <summary>
    /// パスワードをクリア（セキュリティ対策）
    /// </summary>
    private void ClearPasswords()
    {
        userPassword = string.Empty;
        ownerPassword = string.Empty;
    }
}